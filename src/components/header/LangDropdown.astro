---
import { languages } from "../../utils/i18n";

const currentLang = Astro.url.pathname.split("/")[1] || "es";
const selectedLanguage =
    languages.find((l) => l.code === currentLang) || languages[0];
const currPath = Astro.url.pathname;
---

<div class="language-dropdown">
    <button
        type="button"
        class="dropdown-trigger"
        aria-expanded="false"
        aria-haspopup="true"
    >
        <svg
            class="globe-icon"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
        >
            <circle cx="12" cy="12" r="10"></circle>
            <path
                d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"
            ></path>
        </svg>
        <span class="lang-code">{selectedLanguage.code}</span>
        <svg
            class="chevron-icon"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
        >
            <path d="m6 9 6 6 6-6"></path>
        </svg>
    </button>

    <div class="dropdown-content">
        {
            languages.map((lang) => (
                <a
                    href={`/${lang.code}`}
                    class:list={[
                        "dropdown-item",
                        { active: selectedLanguage.code === lang.code },
                    ]}
                >
                    <span class="flag">{lang.flag}</span>
                    <span class="name">{lang.name}</span>
                </a>
            ))
        }
    </div>
</div>

<style>
    .language-dropdown {
        position: relative;
    }

    .dropdown-trigger {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.25rem;
        font-weight: 500;
        color: #9ca3af;
        background: transparent;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        transition:
            color 0.2s ease,
            background-color 0.2s ease;
    }

    .dropdown-trigger:hover {
        color: #ffffff;
        background-color: rgba(255, 255, 255, 0.1);
    }

    .globe-icon {
        width: 1rem;
        height: 1rem;
    }

    .lang-code {
        text-transform: uppercase;
    }

    .chevron-icon {
        width: 0.75rem;
        height: 0.75rem;
        opacity: 0.5;
        transition: transform 0.2s ease;
    }

    .chevron-icon.rotated {
        transform: rotate(180deg);
    }

    .dropdown-content {
        position: absolute;
        right: 0;
        top: 100%;
        margin-top: 0.5rem;
        width: 10rem;
        padding: 0.25rem 0;
        background-color: #3a3a3f;
        border: 1px solid #4b4b52;
        border-radius: 0.5rem;
        box-shadow:
            0 10px 15px -3px rgba(0, 0, 0, 0.3),
            0 4px 6px -4px rgba(0, 0, 0, 0.2);
        opacity: 0;
        visibility: hidden;
        transform: translateY(0.25rem);
        transition:
            opacity 0.2s ease,
            visibility 0.2s ease,
            transform 0.2s ease;
    }

    .dropdown-content.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        color: #9ca3af;
        text-decoration: none;
        transition:
            background-color 0.15s ease,
            color 0.15s ease;
    }

    .dropdown-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: #ffffff;
    }

    .dropdown-item.active {
        background-color: rgba(255, 255, 255, 0.1);
        color: #ffffff;
    }

    .flag {
        font-size: 1rem;
    }

    .name {
        flex: 1;
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const dropdowns = document.querySelectorAll(".language-dropdown");

        dropdowns.forEach((dropdown) => {
            const trigger = dropdown.querySelector(".dropdown-trigger");
            const content = dropdown.querySelector(".dropdown-content");
            const chevron = dropdown.querySelector(".chevron-icon");

            if (!trigger || !content) return;

            trigger.addEventListener("click", (e) => {
                e.stopPropagation();
                const isOpen = trigger.getAttribute("aria-expanded") === "true";
                isOpen ? closeDropdown() : openDropdown();
            });

            function openDropdown() {
                trigger?.setAttribute("aria-expanded", "true");
                content?.classList.add("open");
                chevron?.classList.add("rotated");
            }

            function closeDropdown() {
                trigger?.setAttribute("aria-expanded", "false");
                content?.classList.remove("open");
                chevron?.classList.remove("rotated");
            }

            document.addEventListener("click", (e) => {
                if (!dropdown.contains(e.target as Node)) closeDropdown();
            });

            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") closeDropdown();
            });
        });
    });
</script>
