---
import { languages } from "../../utils/i18n";
import Lang from "../svg/Lang.astro";
import DropArrow from "../svg/DropArrow.astro";

const currentLang = Astro.url.pathname.split("/")[1] || "es";
const selectedLanguage =
    languages.find((l) => l.code === currentLang) || languages[0];

const currentPath = (Astro.url.pathname.replace(`/${currentLang}`, "/<lang>")).concat(Astro.url.search);
---

<div class="language-dropdown">
    <div class="dropdown-trigger" aria-expanded="false" aria-haspopup="true">
        <Lang class="globe-icon" />
        <span class="lang-code">{selectedLanguage.code}</span>
        <DropArrow class="chevron-icon" />
    </div>

    <div class="dropdown-content">
        {
            languages.map((lang) => (
                <a
                    href={currentPath.replace("<lang>", lang.code)}
                    class:list={[
                        "dropdown-item",
                        { active: selectedLanguage.code === lang.code },
                    ]}
                >
                    <span class="flag">{lang.flag}</span>
                    <span class="name">{lang.name}</span>
                </a>
            ))
        }
    </div>
</div>

<style>
    .language-dropdown {
        position: relative;

        .dropdown-trigger {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            font-size: 1.05rem;
            font-weight: 500;
            color: #9ca3af;
            background: transparent;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            transition:
                color 0.2s ease,
                background-color 0.2s ease;
            padding: 0.5rem 1rem;

            &:hover {
                color: #ffffff;
                background-color: rgba(255, 255, 255, 0.1);
            }

            :global(.globe-icon) {
                width: 0.45rem;
                height: 0.45rem;
                flex-shrink: 0;
            }

            .lang-code {
                text-transform: uppercase;
            }

            .chevron-icon {
                width: 0.85rem;
                height: 0.85rem;
                opacity: 0.5;
                transition: transform 0.2s ease;

                &.rotated {
                    transform: rotate(180deg);
                }
            }
        }

        .dropdown-content {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 0.5rem;
            width: 10rem;
            padding: 0.25rem 0;
            background-color: #3a3a3f;
            border: 1px solid #4b4b52;
            border-radius: 0.5rem;
            box-shadow:
                0 10px 15px -3px rgba(0, 0, 0, 0.3),
                0 4px 6px -4px rgba(0, 0, 0, 0.2);
            opacity: 0;
            visibility: hidden;
            transform: translateY(0.25rem);
            transition:
                opacity 0.2s ease,
                visibility 0.2s ease,
                transform 0.2s ease;

            &.open {
                opacity: 1;
                visibility: visible;
                transform: translateY(0);
            }

            .dropdown-item {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
                color: #9ca3af;
                text-decoration: none;
                transition:
                    background-color 0.15s ease,
                    color 0.15s ease;

                &:hover {
                    background-color: rgba(255, 255, 255, 0.1);
                    color: #ffffff;
                }

                &.active {
                    background-color: rgba(255, 255, 255, 0.1);
                    color: #ffffff;
                }

                .flag {
                    font-size: 1rem;
                }

                .name {
                    flex: 1;
                }
            }
        }
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const dropdowns = document.querySelectorAll(".language-dropdown");

        dropdowns.forEach((dropdown) => {
            const trigger = dropdown.querySelector(".dropdown-trigger");
            const content = dropdown.querySelector(".dropdown-content");
            const chevron = dropdown.querySelector(".chevron-icon");
            const links = dropdown.querySelectorAll(".dropdown-item");

            if (!trigger || !content) return;

            links.forEach(link => {
                link.addEventListener("click", () => {
                   const href = link.getAttribute("href");
                   // Extract lang from href (assuming /lang/...)
                   if (href) {
                       const match = href.match(/^\/([a-z]{2})\//);
                       if (match) {
                           localStorage.setItem("preferred_lang", match[1]);
                           document.cookie = `preferred_lang=${match[1]}; path=/; max-age=31536000`;
                       }
                   }
                });
            });

            trigger.addEventListener("click", (e) => {
                e.stopPropagation();
                const isOpen = trigger.getAttribute("aria-expanded") === "true";
                isOpen ? closeDropdown() : openDropdown();
            });

            function openDropdown() {
                trigger?.setAttribute("aria-expanded", "true");
                content?.classList.add("open");
                chevron?.classList.add("rotated");
            }

            function closeDropdown() {
                trigger?.setAttribute("aria-expanded", "false");
                content?.classList.remove("open");
                chevron?.classList.remove("rotated");
            }

            document.addEventListener("click", (e) => {
                if (!dropdown.contains(e.target as Node)) closeDropdown();
            });

            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") closeDropdown();
            });
        });
    });
</script>
